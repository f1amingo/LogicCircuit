<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HAPPY ELIMINATING</title>
    <link rel="stylesheet" type="text/css" href="../assets/css/basic.css"/>
    <!--    <script src="../assets/js/vue.js"></script>-->
    <script src="../assets/js/vue.min.js"></script>
    <!-- import stylesheet -->
    <link rel="stylesheet" href="../assets/css/iview.css">
    <!-- import iView -->
    <script src="../assets/js/iview.min.js"></script>
    <script src="../assets/js/createjs.min.js"></script>
    <script src="../assets/js/preloadjs.min.js"></script>
    <script src="../assets/js/tweenjs.min.js"></script>
    <script src="../assets/js/soundjs.min.js"></script>
</head>
<body>
<div id="app">
    <!--    关卡对话框-->
    <Modal class="z-modal level-modal"
           footer-hide
           v-model="modalLevel">
        <div class="level-body">
            <div class="level-content">
                <img class="level-bg" src="../assets/img/level/bg.png">
                <img class="img-ribbon" src="../assets/img/level/ribbon.png">
                <img @click="modalLevel=false"
                     class="img-level-close" src="../assets/img/level/close.png">
                <div>
                    <!--                    <div v-for="(item,index) in levelList"-->
                    <!--                         class="row-level">-->
                    <!--                        <img class="img-num"-->
                    <!--                             :src="item.lock?`../assets/img/level/${index+1}un.png`:`../assets/img/level/${index+1}.png`">-->
                    <!--                        <img v-for="(star,indexi) in item.stars"-->
                    <!--                             class="img-star"-->
                    <!--                             style="cursor: pointer;"-->
                    <!--                             @click="clickStars(index,indexi,star)"-->
                    <!--                             :src="star?'../assets/img/level/star.svg':'../assets/img/level/star0.svg'">-->
                    <!--                    </div>-->
                    <div class="row-img">
                        <img src="../assets/img/level/easy.png">
                    </div>
                    <div class="level-box">
                        <div v-for="(item,index) in easyLevelList" class="item">
                            <img class="item-img"
                                 :src="item.lock?`../assets/img/level/${index+1}un.png`:`../assets/img/level/${index+1}.png`">
                            <div class="row-stars">
                                <img v-for="bool in item.stars"
                                     :style="{visibility:item.lock?'hidden':'visible'}"
                                     :src="bool?'../assets/img/level/star.png':'../assets/img/level/star0.png'">
                            </div>
                        </div>
                    </div>
                    <div class="row-img">
                        <img src="../assets/img/level/medium.png">
                    </div>
                    <div class="level-box">
                        <div v-for="(item,index) in mediumLevelList" class="item">
                            <img class="item-img"
                                 :src="item.lock?`../assets/img/level/${index+1}un.png`:`../assets/img/level/${index+1}.png`">
                            <div class="row-stars">
                                <img v-for="bool in item.stars"
                                     :style="{visibility:item.lock?'hidden':'visible'}"
                                     :src="bool?'../assets/img/level/star.png':'../assets/img/level/star0.png'">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </Modal>
    <!--    真值表-->
    <Modal class="z-modal"
           footer-hide
           v-model="modalValueTable">
        <div>
            <img style="width:  950px;height: 600px;"
                 src="../assets/img/modal/table.png" alt>
        </div>
    </Modal>
    <!--    tips-->
    <Modal class="z-modal"
           footer-hide
           v-model="modalTips">
        <div>
            <img style="width: 600px;height: 400px;"
                 src="../assets/img/modal/tips.png" alt>
            <div class="div-yes-no">
                <img @click="clickTipYes"
                     style="margin-right: 15px;"
                     src="../assets/img/modal/yes.png" alt>
                <img @click="clickTipNo"
                     style="margin-left: 15px;"
                     src="../assets/img/modal/no.png" alt>
            </div>
        </div>
    </Modal>
    <!--    通关对话框-->
    <Modal class="z-modal"
           :mask-closable="false"
           footer-hide
           v-model="modalCongratulation">
        <div style="text-align: center">
            <img :style="congratulationTransform"
                 style="width: 600px;transition: transform 1s;"
                 src="../assets/img/congratulations.png">
        </div>
    </Modal>
    <!--    自定义对话框实例-->
    <Modal class="z-modal"
           footer-hide
           v-model="tipAlert">
        <div class="modal-custom-body">
            <img class="m-bg" src="../assets/img/modal/bg.png">
            <div class="m-content">
                <p v-text="tipMsg">
                </p>
            </div>
            <div class="row-button">
                <img @click="tipY"
                     style="margin-right: 15px;"
                     src="../assets/img/modal/yes.png" alt>
                <!-- <img @click="tipN"
                     style="margin-left: 15px;"
                     src="../assets/img/modal/no.png" alt> -->
            </div>
        </div>
    </Modal>

    <div class="div-avatar">
        <img @click="clickAvatar()"
             :src="username===''?'../assets/img/avatar0.png':'../assets/img/avatar.png'">
        <span style="    font-size: 32px;
    font-family: fantasy;
    color: white;" v-text="username"></span>
    </div>

    <div class="div-music">
        <img src="../assets/img/page/music.png">
    </div>
    <div class="div-logout" @click="logOut()">
        <span>Log Out</span>
    </div>
    <!--    背景图片-->
    <img src="../assets/img/bg.jpg" class="bg" alt/>
    <!--标题 音乐-->
    <div class="row-title">
        <img src="../assets/img/page/title.png" alt>
    </div>
    <!--    return按钮、next按钮、钟-->
    <div class="row-action">
        <div style="width: 28%;"></div>
        <div class="div-action">
            <img v-show="curIndex===2||curIndex===3"
                 @click="clickReturn"
                 @mouseenter="returnHover=true"
                 @mouseleave="returnHover=false"
                 style="cursor: pointer;"
                 :src="returnHover?'../assets/img/page/return_hover.png':'../assets/img/page/return.png'" alt>
            <img v-show="curIndex===1||curIndex===4"
                 @mouseenter="nextHover=true"
                 @click="clickNext"
                 @mouseleave="nextHover=false"
                 style="cursor: pointer;"
                 :src="nextHover?'../assets/img/page/next_hover.jpg':'../assets/img/page/next.jpg'" alt>
        </div>
        <div class="flex-grow"></div>
        <div v-show="curIndex===0||curIndex===1" class="div-action">
            <img @click="modalValueTable = true"
                 style="cursor: pointer;"
                 src="../assets/img/page/value_table.png" alt>
        </div>
        <div class="div-action">
            <!--            <img v-show="curIndex===4"-->
            <!--                 @mouseenter="submitHover=true"-->
            <!--                 @click="clickSubmit"-->
            <!--                 @mouseleave="submitHover=false"-->
            <!--                 style="cursor: pointer;"-->
            <!--                 :src="submitHover?'../assets/img/page/submit_hover.png':'../assets/img/page/submit.png'" alt>-->
        </div>
        <div v-show="curIndex===2||curIndex===3||curIndex===4">
            <div class="div-clock">
                <img class="img-number"
                     :src="getClockNumberImg(clockTime,0)">
                <img class="img-number"
                     v-show="clockTime>9"
                     :src="getClockNumberImg(clockTime,1)">
                <img class="img-number"
                     v-show="clockTime>99"
                     :src="getClockNumberImg(clockTime,2)">
            </div>
        </div>
    </div>
    <!--    左侧选项按钮、电路图-->
    <div class="div-main">
        <!--左侧菜单-->
        <div class="div-btn">
            <img @mouseenter="mouseoverBtnItem"
                 v-for="(item,index) in btnList"
                 @click="clickMenu(index)"
                 :class="{'active':curIndex===index}"
                 :src="item.img" alt>
        </div>
        <div class="flex-grow main-right">
            <div class="left flex-grow">
                <div v-show="curIndex===0" id="graph0"
                     class="logic-graph flex-grow">
                    <canvas id="canvas0"
                            :height="canvasSize[0].height"
                            :width="canvasSize[0].width"></canvas>
                </div>
                <div v-show="curIndex===1" id="graph1"
                     class="logic-graph flex-grow">
                    <canvas id="canvas1"
                            v-if="showCanvas1"
                            :height="canvasSize[1].height"
                            :width="canvasSize[1].width"></canvas>
                </div>
                <div v-show="curIndex===2 ||curIndex===3" id="graph23"
                     class="logic-graph">
                    <canvas v-for="(tree,index) in curIndex===2?logicTreeEasy:logicTreeMedium"
                            :id="'canvas2'+index"
                            :height="getEasySize(logicTreeEasy.length,logicTreeMedium.length)[0]"
                            @click="clickEasyBox(tree,index)"
                            :class="{active:curEMIndex===index}"
                            :style="showBoxOrNot(tree,index)"
                            :width="getEasySize(logicTreeEasy.length,logicTreeMedium.length)[1]"></canvas>
                </div>
                <div v-show="curIndex===4" id="graph4"
                     class="logic-graph flex-grow">
                    <canvas id="canvas4"
                            :height="canvasSize[4].height"
                            :width="canvasSize[4].width"></canvas>
                </div>
                <div v-show="curIndex===0||curIndex===4" class="zero-one">
                    <img :class="{'select-num':selectNum === '0'}"
                         @click="chooseNum('0')" src="../assets/img/page/0.png" alt>
                    <img :class="{'select-num':selectNum === '1'}"
                         @click="chooseNum('1')" src="../assets/img/page/1.png" alt>
                </div>
            </div>
            <div class="right">
                <div v-for="logic in logicLegends"
                     class="logic-legend">
                    <img :class="{'select-logic':selectLogic === logic}"
                         @click="chooseLogic(logic)"
                         :src="`../assets/img/page/${logic}.png`" alt>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</body>
<script src="../assets/js/jquery-3.2.1.min.js"></script>

<script>
    const app = new Vue({
        el: '#app',
        data: {
            modalTips: false, //提示关卡内容 , 图片显示 , 改为文字
            modalValueTable: false,//真值表
            modalLevel: true,//关卡 星星
            modalCongratulation: false, //通过祝贺 弹窗
            tipAlert: false,//自定义弹窗开关
            tipConfirm: false,//二次提示 开关
            tipMsg: '',//自定义内容
            //初始化星星格式 , 在页面初始化查询关卡通过情况重新初始化
            easyLevelList: [
                {lock: false, stars: [true, true, true]},
                {lock: false, stars: [true, true, false]},
                {lock: false, stars: [true, true, true]},
                {lock: false, stars: [true, false, false]},
                {lock: false, stars: [true, false, false]},
                {lock: false, stars: [true, false, false]},
                {lock: true, stars: [false, false, false]},
                {lock: true, stars: [false, false, false]},
                {lock: true, stars: [false, false, false]},
            ],
            mediumLevelList: [
                {lock: false, stars: [true, true, true]},
                {lock: false, stars: [true, false, false]},
                {lock: false, stars: [true, false, false]},
                {lock: false, stars: [false, false, false]},
                {lock: false, stars: [false, false, false]},
                {lock: false, stars: [false, false, false]},
                {lock: true, stars: [false, false, false]},
                {lock: true, stars: [false, false, false]},
                {lock: true, stars: [false, false, false]},
            ],
            //当前关卡的配置
            boxLevel: {},
            //用户名 用来显示
            username: '',
            //返回按钮
            returnHover: false,
            //下一关
            nextHover: false,
            //提交
            submitHover: false,
            canvasGapX: 25,
            canvasGapY: 10,
            //时间 秒 控制 后面初始化
            clockTime: 60,
            //触发器 的id 到时间后销毁
            tickId: null,
            //当前的菜单 索引 0 开始
            curIndex: 5,
            //当前星星 关卡
            currStar: 1,
            loadData: false,//是否加载完成数据
            //逻辑门 选项
            logicLegends: [
                'XOR',
                'NOR',
                'OR',
                'NAND',
                'AND',
            ],
            //自定义内容信息存放
            msgList: [
                {
                    msg: 'Please freely match 0&1 and logic gate, click on the logic gate to get the result.',
                    y: 'You can also check the value table'
                },
                {
                    msg: 'Please think about what logical relationship is, and choose a suitable logic gate. You can view the value table.',
                    c1: 'Excellent! Think again, there are ',
                    c2: ' suitable logic gate(s).'
                }, {
                    msg1: 'In this round of games, there will be ',
                    msg2: ' boxes. You need to select ANY suitable logic gate within the specified time to make all the boxes disappear.',
                    f: 'You can click on the user name in the upper left corner to see how you light the stars.',
                    c: 'Would you like to continue playing?'
                }, {
                    msg1: 'In this round of games, there will be ',
                    msg2: ' boxes. You need to select ALL the suitable logic gates within the specified time to make all the boxes disappear.',
                    c: 'Would you like to continue playing?'
                }, {
                    msg: 'You can combine the values or logic gates at “?” within the specified time to make the circuit diagram.'
                }
            ],
            //左侧 菜单按钮列表 图片路径及 显示控制
            btnList: [
                {
                    img: '../assets/img/page/what.png',
                    isActive: false,
                }, {
                    img: '../assets/img/page/how.png',
                    isActive: false,
                }, {
                    img: '../assets/img/page/easy.png',
                    isActive: false,
                }, {
                    img: '../assets/img/page/medium.png',
                    isActive: false,
                }, {
                    img: '../assets/img/page/hard.png',
                    isActive: false,
                },
            ],
            canvasSize: [
                {
                    width: '',
                    height: '',
                }, {
                    width: '',
                    height: '',
                }, {
                    width: '10',
                    height: '5',
                }, {
                    width: '10',
                    height: '5',
                }, {
                    width: '',
                    height: '',
                },
            ],
            stage: [{}, {}, [{}, {}, {}], [{}, {}, {}], {}],
            colorRect: '#ffe6be',
            colorRectHover: '#e2c9aa',
            colorLine: '#f19049',
            shadowHover: '#aaaaaa',
            shadowThis: '#3367d6',
            shadowError: '#f00',
            shadowRight: '#1aa260',
            queue: null,
            //第一个 什么是逻辑门 的 电路图初始值
            logicTreeWhat: [
                [{val: '0', edit: true, right: true}, {val: '1', edit: true, right: true}],
                [{val: 'AND', logic: true, edit: true, right: true}],
                [{val: '1'}]
            ],
            //第二个
            logicTreeHow: [
                [{val: '0'}, {val: '0'}],
                [{val: '?', logic: true, edit: true}],
                [{val: '1'}]
            ],
            //第三个
            logicTreeEasy: [
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]]
            ],
            //第四个
            logicTreeMedium: [[[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]],
                [[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]]],
            //第五个
            logicTreeHard: [
                [{val: '?', edit: true}, {val: '0'}, {val: '0'}, {val: '0'}, {val: '0'}, {val: '0'}],
                [{val: 'OR', logic: true}, {val: '?', logic: true, edit: true}, {val: 'AND', logic: true}],
                [{val: '0'}, {val: '0'}, {val: '0'}],
                [{val: 'AND', logic: true}, {val: 'OR', logic: true}],
                [{val: '?', edit: true,}, {val: '?', edit: true,}],
                [{val: 'AND', logic: true}],
                [{val: '0'}],
            ],
            /* logicTreeHard: [
                 [{edit: true, val: '?'}, {val: '0'}, {edit: true, val: '?'}, {val: '0'}, {val: '0'}, {val: '0'}],
                 [{logic: true, val: 'OR'}, {logic: true, edit: true, val: '?'}, {logic: true, val: 'AND'}],
                 [{val: '0'}, {val: '0'}, {val: '0'}],
                 [{logic: true, val: 'AND'}, {logic: true, val: 'OR'}],
                 [{edit: true, val: '?'}, {edit: true, val: '?'}],
                 [{logic: true, val: 'AND'}],
                 [{val: '0'}]
             ],*/
            // easySize: [[150, 225], [100, 150], [80, 120]],
            easySize: [[100, 150], [100, 150], [80, 120]],
            curNode: null,
            curShape: null,
            //当前选中数字
            selectNum: null,
            //当前选中逻辑门
            selectLogic: null,
            //不弹出关卡星星
            modalLevelOFF: true,
            congratulationTransform: {
                transform: 'translateY(0)'
            },
            curEMIndex: -1,
            showCanvas1: true,
        },
        watch: {
            curIndex() {
                this.showCanvas1 = true;
                setTimeout(() => {
                    this.setupCanvasSize();
                    this.drawLogicTree(this.curIndex);
                }, 1);
                if (this.curIndex === 2 || this.curIndex === 3 || this.curIndex === 4) {
                    this.startTick(60);
                    createjs.Sound.play("ready");
                }
            },
            modalValueTable() {
                if (this.modalValueTable)
                    createjs.Sound.play("think");
            },
            modalCongratulation() {
                if (this.modalCongratulation) {
                    setTimeout(() => {
                        app.congratulationTransform = {
                            transform: 'translateY(100vh)'
                        }
                    }, 1500);
                    setTimeout(() => {
                        //在how时不显示关卡
                        if (app.curIndex !== 1) {
                            app.modalLevel = true;
                        }
                        app.modalCongratulation = false;
                        app.congratulationTransform = {
                            transform: 'translateY(0)'
                        }
                    }, 2500);
                }
            }
        },
        mounted() {
            //查询关卡
            var me = this;
            if (localStorage.getItem('curIndex'))
                this.curIndex = parseInt(localStorage.getItem('curIndex'));

            this.username = localStorage.getItem('username');
            this.queue = new createjs.LoadQueue();
            this.queue.installPlugin(createjs.Sound);
            this.queue.loadManifest([
                {id: "0", src: '../assets/img/graph/0.png'},
                {id: "1", src: '../assets/img/graph/1.png'},
                {id: "AND", src: '../assets/img/graph/AND.png'},
                {id: "NAND", src: '../assets/img/graph/NAND.png'},
                {id: "NOR", src: '../assets/img/graph/NOR.png'},
                {id: "OR", src: '../assets/img/graph/OR.png'},
                {id: "XOR", src: '../assets/img/graph/XOR.png'},
                {id: "?", src: '../assets/img/graph/Q.png'},
                //音乐
                {id: "bg", src: '../assets/mp3/bg.mp3'},
                {id: "fail", src: '../assets/mp3/matchFail.mp3'},
                {id: "success", src: '../assets/mp3/matchSuccess.mp3'},
                {id: "victory", src: '../assets/mp3/victory.mp3'},
                {id: "mover", src: '../assets/mp3/mover.mp3'},
                {id: "timeout", src: '../assets/mp3/timeout.mp3'},
                {id: "think", src: '../assets/mp3/think.mp3'},
                {id: "ready", src: '../assets/mp3/ready.mp3'},
            ]);
            this.queue.on("complete", handleComplete, this);

            function handleComplete() {
                app.setupCanvasSize();
                app.loadLevelInfo();
                app.drawLogicTree(this.curIndex);
                createjs.Sound.play("bg", {loop: -1, volume: 0.2});
            }

            window.onresize = () => {
                app.setupCanvasSize();
                app.drawLogicTree(this.curIndex);
            };
            //根据关卡显示提示
            this.showTips();

        },
        methods: {
            getEasySize(easyLen, mediumLen) {
                let curLen = easyLen;
                if (this.curIndex === 3)
                    curLen = mediumLen;
                if (curLen <= 8) {
                    return this.easySize[0];
                } else if (curLen <= 15) {
                    return this.easySize[1];
                } else {
                    return this.easySize[2];
                }
            },
            clickEasyBox(tree, index) {
                //点击easy medium盒子事件
                this.curEMIndex = index;
                createjs.Sound.play("mover");
                if (!this.selectLogic)
                    return;
                if (this.tickId == null) {//时间到不能再点击
                    return;
                }
                tree[1][0].val = this.selectLogic;
                let num1 = tree[0][0];
                let num2 = tree[0][1];
                let num3 = tree[2][0];
                let op = tree[1][0];
                this.curNode = op;
                if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                    createjs.Sound.play("success");
                } else {
                    createjs.Sound.play("fail");
                }
                //是否通过
                let allRight = this._IsEasyMediumAllRight(this.curIndex);
                this._OnAllRightChanged(allRight);
            },
            _OnAllRightChanged(allRight) {
                //每次选择后会回调，用于判断通关与否
                if (allRight) {
                    console.log('通关');
                    //easy medium hard通关
                    createjs.Sound.play("victory");
                    //what不显示Congratulations
                    if (this.curIndex !== 0)
                        this.modalCongratulation = true;
                } else {
                    console.log('不通关');
                    this.curNode.right ? createjs.Sound.play("success") : createjs.Sound.play("fail");
                }
                //每匹配一次清空上一次选中的
                this.curEMIndex = -1;
                this.selectLogic = '';
            },
            levelPass() {
                let box = this.boxLevel;
                let wait = true;
                if (box && box.id === 1) {
                    this.levelList[0].stars[0] = true;
                    this.modalLevel = true;
                    this.tipMsg = this.msgList[2].f;
                    this.tipAlert = true;
                }
                this.modalCongratulation = true;
                this.modalLevelOFF = true;
                let me = this;
                $.get("/api/user/boxLevel/logLevel/" + me.boxLevel.id, function (rs) {
                    if (rs) {
                        if (me.modalLevel) {
                            let i_setInterval = setInterval(function () {
                                if (!me.modalLevel) {
                                    //询问是否下一关
                                    me.levelPassed = true;
                                    me.tipMsg = me.msgList[me.curIndex].c;
                                    me.tipAlert = true;
                                    clearInterval(i_setInterval);
                                }
                            }, 1000);
                        } else {
                            //询问是否下一关
                            me.levelPassed = true;
                            me.tipMsg = me.msgList[me.curIndex].c;
                            me.tipAlert = true;
                        }
                    } else {
                        alert('记录通过记录失败');
                    }
                });
            },
            showBoxOrNot(tree, index) {
                let num1 = tree[0][0];
                let num2 = tree[0][1];
                let num3 = tree[2][0];
                let op = tree[1][0];
                if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                    return {visibility: 'hidden'};
                } else {
                    return {visibility: 'visible'};
                }
                // let logic = tree[1][0];
                // //答案正确
                // if (logic.right) {
                //     return {visibility: 'hidden'};
                // } else {
                //     return this.judgeLevel(tree, index);
                // }
            },
            judgeLevel(tree, index) {
                let num1 = tree[0][0];
                let num2 = tree[0][1];
                let logic = tree[1][0];
                let num3 = tree[2][0];
                let op = tree[1][0];
                let currBoxNum = this.currBoxNum;
                if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                    if (this.mustSelectAll) {
                        //必选全选
                        let i = $.inArray(op.val, logic.rightLogic);
                        if (i > -1) {//在其中
                            //剔除这个答案
                            logic.rightLogic.splice(i, 1);
                            //判断是否为空
                            if (logic.rightLogic.length <= 0) {
                                //全部选出
                                this.selectBoxNum++;
                                logic.right = true;
                                //查询还多少个没选
                                if (currBoxNum <= this.selectBoxNum) {//完成
                                    this.levelPass();
                                }
                                return {visibility: 'hidden'};
                            }
                        }
                        return {visibility: 'visible'};
                    } else {
                        //选中一个即可
                        this.selectBoxNum++;
                        logic.right = true;
                        //查询还多少个没选
                        if (currBoxNum <= this.selectBoxNum) {//完成
                            this.levelPass();
                        }
                        return {visibility: 'hidden'};
                    }
                } else {
                    return {visibility: 'visible'};
                }
            },
            //后端添加 渲染星星 传入的是已经通过的关id
            setStars(id) {
                if (this.curIndex === 3 && id < 9) {//中等难度
                    this.clickMenu(2);//跳回2
                }
                /*  最后一关限制
                    if (this.curIndex===4&&id<18){
                        this.clickMenu((id/9)+1);
                    }

                  */
                this.currStar = id + 1;
                var level = parseInt(id / 3 + 1);//每关3星
                for (var i = 0; i < this.levelList.length; i++) {
                    if (i < level) {
                        this.levelList[i].lock = false;
                        if (i < level - 1) {
                            this.levelList[i].stars = [true, true, true];
                        } else {
                            for (var j = 0; j < id % 3; j++) {
                                this.levelList[i].stars[j] = true;
                            }
                        }
                    } else {
                        break;
                    }
                }
            },
            goToNextLevel() {
                var box = this.boxLevel;
                if (box && box.id == 1) {
                    this.levelList[0].stars[0] = true;
                    this.modalLevel = true;
                    this.tipMsg = this.msgList[2].f;
                    this.tipAlert = true;
                }
                this.modalCongratulation = true;
            },
            fillBlank(logicTree) {
                console.log("当前选中curNode:" + JSON.stringify(this.curNode));
                console.log("当前选中逻辑门:" + this.selectLogic + ",当前选中数字:" + this.selectNum);
                if (!this.curNode.edit)
                    return;
                if (this.curNode.logic) {//选中逻辑门
                    if (!this.selectLogic)
                        return;
                    this.curNode.val = this.selectLogic;
                    this.judgeLogicTree(this.curIndex, logicTree);
                    this.updateLogicTree(this.curIndex);
                }
                if (!this.curNode.logic) {//选中数字
                    if (!this.selectNum)
                        return;
                    this.curNode.val = this.selectNum;
                    this.judgeLogicTree(this.curIndex, logicTree);
                    this.updateLogicTree(this.curIndex);
                }
                // console.log("当前值:" + JSON.stringify(this.logicTreeHard));
            },
            //输入 和 输出 得出全部正确 逻辑门
            // //[[{val: '1',}, {val: '1',}], [{val: '?', logic: true, edit: true}], [{val: '1'}]]
            loopAllRight: function (item) {
                let allLogic = this.logicLegends;
                let rightLogic = [];
                for (let l of allLogic) {
                    if (item[2][0].val == this.operate(l, item[0][0].val, item[0][1].val)) {
                        rightLogic.push(l);
                    }
                }
                item[1][0].rightLogic = rightLogic;
            },
            judgeLogicTree(index, logicTree) {
                //每个小项是否都正确，通关判断条件
                let allRight = true;
                if (index === 0) {
                    //他这里用的是数组序列 所以从0 开始数
                    //第1 什么是逻辑门
                    let wa = this.logicTreeWhat;
                    if (wa[1][0].logic) {
                        wa[2][0].val = this.operate(wa[1][0].val, wa[0][0].val, wa[0][1].val);
                    }
                    allRight = false;
                } else if (index === 1) {
                    let rightCount = 0;
                    let logicList = ['XOR', 'NOR', 'OR', 'NAND', 'AND'];
                    let num1 = this.logicTreeHow[0][0];
                    let num2 = this.logicTreeHow[0][1];
                    let num3 = this.logicTreeHow[2][0];
                    let op = this.logicTreeHow[1][0];
                    if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                        //    选对了 自定义逻辑
                        createjs.Sound.play("success");
                        op.right = true;
                        this.modalCongratulation = true;
                        this.selectLogic = '';
                        this.selectNum = '';
                        this.showCanvas1 = false;
                    } else {
                        for (let logic of logicList) {
                            if (this.operate(logic, num1.val, num2.val) === num3.val)
                                rightCount++;
                        }
                        //    选错了 自定义逻辑
                        createjs.Sound.play("fail");
                        op.right = false;
                        this.tipMsg = this.msgList[1].c1 + rightCount + this.msgList[1].c2;
                        this.tipAlert = true;
                    }
                    allRight = false;
                } else if (index === 2 || index === 3) {
                    allRight = this._IsEasyMediumAllRight(index);
                } else if (index === 4) {
                    for (let i = 0; i < logicTree.length; i++, i++) {
                        let treeLevel = logicTree[i];
                        if (i === 0) {
                            for (let j = 0; j < treeLevel.length; j++, j++) {
                                let num1 = treeLevel[j];
                                let num2 = treeLevel[j + 1];
                                let num3 = logicTree[i + 2][j / 2];
                                let op = logicTree[i + 1][j / 2];
                                if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                                    for (let item of [num1, num2, num3, op])
                                        item.right = true;
                                } else {
                                    allRight = false;
                                    for (let item of [num1, num2, num3, op])
                                        item.right = false;
                                }
                            }
                            if (!allRight) break;
                        } else if (i === 2) {
                            for (let j = 1; j < treeLevel.length; j++) {
                                let num1 = treeLevel[j - 1];
                                let num2 = treeLevel[j];
                                let num3 = logicTree[i + 2][j - 1];
                                let op = logicTree[i + 1][j - 1];
                                if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                                    for (let item of [num1, num2, num3, op])
                                        item.right = true;
                                } else {
                                    allRight = false;
                                    for (let item of [num1, num2, num3, op])
                                        item.right = false;
                                }
                            }
                            if (!allRight) break;
                        } else if (i === 4) {
                            let num1 = treeLevel[0];
                            let num2 = treeLevel[1];
                            let num3 = logicTree[i + 2][0];
                            let op = logicTree[i + 1][0];
                            if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                                for (let item of [num1, num2, num3, op])
                                    item.right = true;
                            } else {
                                allRight = false;
                                for (let item of [num1, num2, num3, op])
                                    item.right = false;
                            }
                        }
                    }
                }
                this._OnAllRightChanged(allRight);
            },
            _IsEasyMediumAllRight(index) {
                let allRight = true;
                let logicTreeList = this.logicTreeEasy;
                if (index === 3)
                    logicTreeList = this.logicTreeMedium;
                for (let tree of logicTreeList) {
                    let num1 = tree[0][0];
                    let num2 = tree[0][1];
                    let num3 = tree[2][0];
                    let op = tree[1][0];
                    if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                        for (let item of [num1, num2, num3, op])
                            item.right = true;
                    } else {
                        for (let item of [num1, num2, num3, op])
                            item.right = false;
                        allRight = false;
                    }
                }
                return allRight;
            },
            setupCanvasSize() {
                let domList = [
                    document.getElementById('graph0'),
                    document.getElementById('graph1'),
                    document.getElementById('graph0'),//占位
                    document.getElementById('graph0'),//占位
                    document.getElementById('graph4'),
                ];

                for (let i in domList) {
                    let width = domList[i].clientWidth;
                    let height = domList[i].clientHeight;
                    if (i === '2' || i === '3') {
                        //-2去掉边框宽度
                        width = (width - 3 * this.canvasGapX) / 2 - 2;
                        height = (height - 3 * this.canvasGapY) / 2 - 2;
                        //不显示时，高宽会变负数，导致canvas变成默认大小
                        if (width < 0 || height < 0)
                            continue;
                    }
                    this.canvasSize[i].width = width;
                    this.canvasSize[i].height = height;
                }
            },
            //只有盒子的图
            _drawLogicTreeOnlyBox(logicTree, stage, cW, cH) {
                if (logicTree.length === 0)
                    return;
                stage.removeAllChildren();
                stage.clear();
                let gap = cH * 0.05;
                let rect1H = (cH - gap * 3) / 2;
                let rect1W = (cW - gap * 3) / 2;
                let rect2H = cH - gap * 2;
                let rect2W = rect1W;

                let rect1 = new createjs.Shape();
                rect1.graphics
                    .f(this.colorRect).rr(gap, gap, rect1W, rect1H, 5);
                let rect2 = new createjs.Shape();
                rect2.graphics
                    .f(this.colorRect)
                    .rr(gap, rect1H + gap * 2, rect1W, rect1H, 5);
                let rect3 = new createjs.Shape();
                rect3.graphics
                    .f(this.colorRect)
                    .rr(cW - gap - rect2W, gap, rect2W, rect2H, 5);
                console.log("logicTree[0][0].val = >" + logicTree[0][0].val);
                console.log(cW + "  =====    " + cH);
                let img1 = new createjs.Bitmap(this.queue.getResult(logicTree[0][0].val));
                let wh = this.scaleBitmap(img1, rect1H);
                img1.x = gap + rect1W / 2 - wh[0] / 2;
                img1.y = gap + rect1H / 2 - wh[1] / 2;

                console.log("logicTree[0][1].val = >" + logicTree[0][1].val);
                let img2 = new createjs.Bitmap(this.queue.getResult(logicTree[0][1].val));
                wh = this.scaleBitmap(img2, rect1H);
                img2.x = gap + rect1W / 2 - wh[0] / 2;
                img2.y = cH - gap - rect1H / 2 - wh[1] / 2;

                console.log("logicTree[2][0].val = >" + logicTree[2][0].val);
                let img4 = new createjs.Bitmap(this.queue.getResult(logicTree[2][0].val));
                wh = this.scaleBitmap(img4, rect1H);
                img4.x = cW - gap - rect2W / 2 - wh[0] / 2;
                img4.y = gap + rect2H / 2 - wh[1] / 2;

                // let treeNodeList = [logicTree[0][0], logicTree[0][1], logicTree[2][0]];
                // let objList = [rect1, rect2, rect3];
                // for (let i in objList) {
                //     let obj = objList[i];
                //     let node = treeNodeList[i];
                //     if (node.current) {
                //         this.curNode = node;
                //     }
                //     app.setShadow(node, obj);
                //     obj.on('mouseover', evt => {
                //         app.setShadow(node, obj, true);
                //     });
                //     obj.on('mouseout', evt => {
                //         app.setShadow(node, obj);
                //         createjs.Sound.play("mover");
                //     });
                //     obj.on('click', evt => {
                //         app.curNode = node;
                //         app.fillBlank(logicTree);
                //     });
                // }
                for (let child of [rect1, rect2, rect3, img1, img2, img4])
                    stage.addChild(child);
            },
            _drawLogicTree3Elements(logicTree, stage, cW, cH) {
                if (logicTree.length === 0)
                    return;
                stage.removeAllChildren();
                stage.clear();
                let gap = cH * 0.05;
                let rect1H = (cH - gap * 3) / 2;
                let rect1W = rect1H * 1.75;
                let rect2H = cH - gap * 2;
                let rect2W = rect2H / 1.75;
                let strokeW = rect1H * 0.18;
                //线段中点的X坐标
                let centerX = (cW - 2 * gap - rect1W - rect2W) / 2 + gap + rect1W;
                let centerY = cH / 2;
                let rect1 = new createjs.Shape();
                rect1.graphics
                    .f(this.colorRect).rr(gap, gap, rect1W, rect1H, 5);
                let rect2 = new createjs.Shape();
                rect2.graphics
                    .f(this.colorRect)
                    .rr(gap, rect1H + gap * 2, rect1W, rect1H, 5);
                let rect3 = new createjs.Shape();
                rect3.graphics
                    .f(this.colorRect)
                    .rr(cW - gap - rect2W, gap, rect2W, rect2H, 5);
                let mtPosY = gap + rect1H / 2;
                let qtPosY = mtPosY + strokeW;
                let line = new createjs.Shape();
                line.graphics.s(this.colorLine)
                    .ss(strokeW)
                    .mt(gap, mtPosY)
                    .lt(centerX - strokeW, mtPosY)
                    .qt(centerX, mtPosY, centerX, qtPosY)
                    .mt(gap, cH - mtPosY)
                    .lt(centerX - strokeW, cH - mtPosY)
                    .qt(centerX, cH - mtPosY, centerX, cH - qtPosY)
                    .lt(centerX, qtPosY)
                    .mt(centerX, centerY)
                    .lt(cW - gap, centerY);
                let img1 = new createjs.Bitmap(this.queue.getResult(logicTree[0][0].val));
                let wh = this.scaleBitmap(img1, rect1H);
                img1.x = gap + rect1W / 2 - wh[0] / 2;
                img1.y = gap + rect1H / 2 - wh[1] / 2;

                let img2 = new createjs.Bitmap(this.queue.getResult(logicTree[0][1].val));
                wh = this.scaleBitmap(img2, rect1H);
                img2.x = gap + rect1W / 2 - wh[0] / 2;
                img2.y = cH - gap - rect1H / 2 - wh[1] / 2;

                let img4 = new createjs.Bitmap(this.queue.getResult(logicTree[2][0].val));
                wh = this.scaleBitmap(img4, rect1H);
                img4.x = cW - gap - rect2W / 2 - wh[0] / 2;
                img4.y = gap + rect2H / 2 - wh[1] / 2;

                let img3 = new createjs.Bitmap(this.queue.getResult(logicTree[1][0].val));
                wh = this.scaleBitmap(img3, rect1H, true);
                img3.x = centerX - wh[0] / 2;
                img3.y = centerY - wh[1] / 2;

                let treeNodeList = [logicTree[0][0], logicTree[0][1], logicTree[1][0], logicTree[2][0]];
                let objList = [rect1, rect2, img3, rect3];
                for (let i in objList) {
                    let obj = objList[i];
                    let node = treeNodeList[i];
                    if (node.current) {
                        this.curNode = node;
                    }
                    app.setShadow(node, obj);
                    obj.on('mouseover', evt => {
                        app.setShadow(node, obj, true);
                    });
                    obj.on('mouseout', evt => {
                        app.setShadow(node, obj);
                        createjs.Sound.play("mover");
                    });
                    obj.on('click', evt => {
                        app.curNode = node;
                        app.fillBlank(logicTree);
                    });
                }
                for (let child of [line, rect1, rect2, rect3, img1, img2, img3, img4])
                    stage.addChild(child);

            },
            _drawLogicTreeMoreElements(logicTree, stage, cW, cH) {
                if (logicTree.length === 0)
                    return;
                stage.removeAllChildren();
                stage.clear();
                let _this = this;
                //图片最左结点数量
                let leafCount = logicTree[0].length;
                //数字列数目
                let numColCount = Math.ceil(logicTree.length / 2);
                let gap = cH * 0.04;
                let rectH = (cH - gap * (leafCount + 1)) / leafCount;
                let rectW = rectH * 1.75;
                let strokeW = rectH * 0.2;
                //水平两个数字之间线段的水平距离
                let eachLineWidth = (cW - 2 * gap - numColCount * rectW) / (numColCount - 1);
                let firstLineY = gap + rectH / 2;
                let lineYList = [];
                for (let i in logicTree[0]) {
                    lineYList.push(firstLineY);
                    firstLineY += gap + rectH;
                }
                let res = {
                    x: gap,
                    y: lineYList
                };
                for (let i = 0; i < logicTree.length; i++, i++) {
                    res = _drawNumberLevel(logicTree[i], res.x, res.y, logicTree[i + 1]);
                }

                function _drawNumberLevel(treeLevel, lineX, lineYList, logicList) {
                    let newLineYList = [];
                    let newlineX = -1;
                    let newlineY = -1;
                    let x = lineX;
                    let isEven = treeLevel.length % 2 === 0;
                    //遍历数字列的每一个数字
                    for (let i = 0; i < treeLevel.length; i++) {
                        let y = lineYList[i] - rectH / 2;
                        let lineY = lineYList[i];
                        let nextLineY = lineYList[i + 1];
                        let node = treeLevel[i];
                        let rect = new createjs.Shape();
                        rect.graphics
                            .f(_this.colorRect).rr(x, y, rectW, rectH, 5);
                        app.setShadow(node, rect);
                        rect.on('mouseover', evt => {
                            app.setShadow(node, rect, true);
                        });
                        rect.on('mouseout', evt => {
                            app.setShadow(node, rect);
                            createjs.Sound.play("mover");
                        });
                        rect.on('click', evt => {
                            app.curNode = node;
                            app.fillBlank(logicTree)
                        });
                        let imgNum = new createjs.Bitmap(_this.queue.getResult(node.val));
                        let wh = app.scaleBitmap(imgNum, rectH);
                        let imgX = lineX + rectW / 2 - wh[0] / 2;
                        let imgY = lineYList[i] - wh[1] / 2;
                        imgNum.x = imgX;
                        imgNum.y = imgY;
                        if ((isEven && i % 2 === 0) || (!isEven && i !== treeLevel.length - 1)) {
                            //每对数字第一个画线
                            let line = new createjs.Shape();
                            newlineX = lineX + rectW + eachLineWidth;
                            newlineY = (lineY + nextLineY) / 2;
                            line.graphics
                                .s(_this.colorLine)
                                .ss(strokeW)
                                .moveTo(lineX, lineY)
                                .lineTo(lineX + rectW + eachLineWidth / 2 - strokeW, lineY)
                                .qt(lineX + rectW + eachLineWidth / 2, lineY, lineX + rectW + eachLineWidth / 2, lineY + strokeW)
                                .moveTo(lineX, nextLineY)
                                .lineTo(lineX + rectW + eachLineWidth / 2 - strokeW, nextLineY)
                                .qt(lineX + rectW + eachLineWidth / 2, nextLineY, lineX + rectW + eachLineWidth / 2, nextLineY - strokeW)
                                .lt(lineX + rectW + eachLineWidth / 2, lineY + strokeW)
                                //合并线
                                .mt(lineX + rectW + eachLineWidth / 2, newlineY)
                                .lt(newlineX, newlineY);
                            newLineYList.push(newlineY);

                            stage.addChild(line);
                            lineY += 2 * (rectH + gap);
                            //画逻辑符号
                            let logicNode = logicList[Math.floor(i / 2)];
                            if (!isEven)
                                logicNode = logicList[i];
                            let imgLogic = new createjs.Bitmap(_this.queue.getResult(logicNode.val));
                            let wh = app.scaleBitmap(imgLogic, rectH, true);
                            imgLogic.x = newlineX - eachLineWidth / 2 - wh[0] / 2;
                            imgLogic.y = newlineY - wh[1] / 2;
                            app.setShadow(logicNode, imgLogic);
                            imgLogic.on("mouseover", evt => {
                                app.setShadow(logicNode, imgLogic, true);
                            });
                            imgLogic.on("mouseout", evt => {
                                app.setShadow(logicNode, imgLogic);
                                createjs.Sound.play("mover");
                            });
                            imgLogic.on('click', evt => {
                                app.curNode = logicNode;
                                app.fillBlank(logicTree);
                            });
                            stage.addChild(imgLogic);
                        }
                        stage.addChild(rect);
                        stage.addChild(imgNum);
                        y += rectH + gap;
                        imgY += rectH + gap;
                    }
                    return {
                        x: newlineX,
                        y: newLineYList
                    };
                }
            },
            updateLogicTree(index) {
                let stageInEasyMedium = this.stage[2];
                let logicTree = [
                    this.logicTreeWhat,
                    this.logicTreeHow,
                    this.logicTreeEasy,
                    this.logicTreeMedium,
                    this.logicTreeHard][index];
                if (!logicTree || logicTree.length === 0)
                    return;
                let stage = this.stage[index];
                let cW = this.canvasSize[index].width;
                let cH = this.canvasSize[index].height;
                console.log("开始渲染=============")
                if (index === 2 || index === 3) {
                    let wh = this.getEasySize(this.logicTreeEasy.length, this.logicTreeMedium.length);
                    cH = wh[0];
                    cW = wh[1];
                    for (let i in stageInEasyMedium) {
                        if (logicTree[i].length === 3) {
                            this._drawLogicTreeOnlyBox(logicTree[i], stageInEasyMedium[i], cW, cH);
                        }
                    }
                } else {
                    if (logicTree.length === 3)
                        this._drawLogicTree3Elements(logicTree, stage, cW, cH);
                    else
                        this._drawLogicTreeMoreElements(logicTree, stage, cW, cH);
                }
                console.log("开始渲染======完毕=======")
            },
            randomArea(min, max) {
                return parseInt(Math.random() * (max - min + 1) + min, 10)
            },
            //随机生成盒子数 在
            randomCreateBOX(n) {
                // console.log("当前管卡 : "+this.curIndex);
                console.log('测试获取 logicTreeEasy data' + JSON.stringify(this.logicTreeEasy))
                console.log("生成盒子数量 : " + n);
                let logic = this.logicLegends;
                //重置
                let list = [];
                for (let i = 0; i < n; i++) {
                    //输入值
                    let a = Math.round(Math.random()) + "";
                    let op = logic[this.randomArea(0, logic.length - 1)];
                    let b = Math.round(Math.random()) + "";
                    //   console.log("[a:"+a+" b:"+b+"op:"+op+"]");
                    //随机 一个逻辑门输出
                    let out = this.operate(op, a, b);
                    let t = [[{val: a}, {val: b}], [{val: '?', logic: true, edit: true}], [{val: out}]]
                    if (this.curIndex === 3) {
                        this.loopAllRight(t);
                    }
                    console.log("生成盒子:" + JSON.stringify(t));
                    list.push(t)
                }
                if (this.curIndex === 3) {
                    this.logicTreeMedium = list;
                } else {
                    this.logicTreeEasy = list;
                }
                console.log("管卡数据加载完成===");
            },
            //加载关卡信息
            loadLevelInfo() {
                let me = this;
                //同步全局设置
                $.ajaxSetup({
                    async: false
                });
                if (this.curIndex === 0) {
                    me.loadData = true;
                }

                //加载第二关 随机数
                if (this.curIndex === 1) {
                    this.logicTreeHow = [
                        [{val: Math.round(Math.random())}, {val: Math.round(Math.random())}],
                        [{val: '?', logic: true, edit: true}],
                        [{val: '1'}]
                    ]
                    this.loopAllRight(this.logicTreeHow);
                    me.loadData = true;
                }
                //加载星星
                // $.get("/api/user/boxLevel/getMaxLevel", function (rs) {
                //     if (rs.code == "0000") {
                //         //设置星星
                //         app.setStars(rs.data);
                //         console.log(rs.data);
                //         //查询关卡配置
                //         if (me.curIndex === 2 || me.curIndex === 3) {
                //             let nextId = rs.data + 1;
                //             let select = localStorage.getItem('selectLevel');
                //             if (select) {
                //                 nextId = select;
                //             }
                //             $.get("/api/user/boxLevel/getLevel/" + nextId, function (rsp) {
                //                 if (rsp.code == "3001") {
                //                     me.tipMsg = '没有下一关';
                //                     //没有下一关
                //                     me.tipAlert = true;
                //                 } else if (rsp.code == "0000") {
                //                     me.boxLevel = rsp.data;
                //                     me.mustSelectAll = rsp.data.selectAll;
                //                     me.currBoxNum = rsp.data.boxNum;
                //                     me.selectBoxNum = 0;
                //                     me.clockTime = rsp.data.timeLock;
                //                     me.randomCreateBOX(me.currBoxNum);
                //                     me.loadData = true;
                //                     //单独显示
                //                     me.tipMsg = me.msgList[me.curIndex].msg1 + me.currBoxNum + me.msgList[me.curIndex].msg2;
                //                     me.tipAlert = true;
                //                     /*    "id": 4,
                //                           "preLockId": 3,
                //                           "boxNum": 15,
                //                           "timeLock": 60,
                //                           "selectAll": false*/
                //                 } else {
                //                     alert(rsp.msg);
                //                 }
                //             });
                //         }
                //     } else {
                //         alert(rs.msg);
                //     }
                // });
                //如果玩最后一关 再加载最后一关题目 , 随机出题
                if (this.curIndex === 4) {
                    // 加载题目
                    this.loadHardLevel();
                }
            },
            paraseData(list) {
                let templist = []

                let layer = list[0].layer; //获取第一个层级
                let layerList = []; //一层级 列表
                for (let i in list) {
                    let c = list[i];
                    if (layer == c.layer) {
                        layerList.push(toObj(c));
                    } else {
                        //如果是下一层级 则将层级记录
                        layer = c.layer;
                        //将上层级 注入
                        templist.push(layerList);
                        //重置层级列表  并将当前存入
                        layerList = [toObj(c)];
                    }
                }

                //最后一个判断是否还有层级列表中未 注入的项
                if (layerList.length > 0) {
                    templist.push(layerList);
                }
                //   this.logicTreeHard.push([]);
                //  console.log("最后得出对象:" + JSON.stringify(this.logicTreeHard));
                this.logicTreeHard = templist;

                function toObj(i) {
                    let obj = {};

                    if (i.type == '1') {//1 是逻辑门
                        obj.logic = true;
                    }
                    if (i.val == '?') {
                        obj.edit = true;
                    }
                    obj.val = i.val;
                    return obj;
                }
            },
            loadHardLevel() {
                let me = this;
                //模拟 加载题目

                $.get("/api/user/getRandomHard", function (rsp) {
                    if (rsp.code == "0000") {
                        me.clockTime = rsp.data.time;
                        //解析后台数据到前端渲染
                        me.paraseData(rsp.data.subjectInputs);
                        me.loadData = true;
                    } else {
                        alert(rsp.msg);
                    }
                });
            },
            //从 0 开始 数
            clickMenu(i) {
                localStorage.setItem('curIndex', i);
                location.href = location.href;
            },
            //根据菜单显示提示
            showTips() {
                let curr = this.curIndex;
                if (curr != 3 && curr != 2) {//23 关单独 显示多少个盒子
                    this.tipMsg = this.msgList[curr].msg;
                    this.tipAlert = true;
                }
            },
            //画逻辑门图
            drawLogicTree(index) {
                // if (!this.loadData) {
                //     return;
                // }
                //easy页的canvas id集合
                console.log("当前logicTreeMedium" + JSON.stringify(this.logicTreeMedium))
                let idList = [];
                if (index === 3) {
                    for (let i in this.logicTreeMedium)
                        idList.push('canvas2' + i);
                } else {
                    for (let i in this.logicTreeEasy)
                        idList.push('canvas2' + i);
                }
                let stageInEasyMedium = [];
                for (let cid of idList)
                    stageInEasyMedium.push(new createjs.Stage(cid));

                this.stage = [new createjs.Stage("canvas0"),
                    new createjs.Stage("canvas1"), stageInEasyMedium, stageInEasyMedium,
                    new createjs.Stage("canvas4"),];

                createjs.Ticker.framerate = 60;

                for (let stage of [this.stage[0], this.stage[1], this.stage[4], ...stageInEasyMedium]) {
                    createjs.Ticker.addEventListener("tick", stage);
                    //   stage.enableMouseOver(10);
                }

                this.updateLogicTree(index);

            },
            //缩放bitmap返回缩放后的width，height
            scaleBitmap(bitmap, rectH, isLogic) {
                let ratio = 0.5;
                if (isLogic)
                    ratio = 0.7;
                let numTrueH = bitmap.getBounds().height;
                let numScale = rectH * ratio / numTrueH;
                bitmap.scaleX = bitmap.scaleY = numScale;
                return [bitmap.getTransformedBounds().width, bitmap.getTransformedBounds().height]
            },
            setShadow(node, shape, hover) {
                if (node.edit)
                    if (node.right)
                        shape.shadow = new createjs.Shadow(app.shadowRight, 0, 0, 5);
                    else
                        shape.shadow = new createjs.Shadow(app.shadowError, 0, 0, 5);
                else
                    shape.shadow = null;
                if (node.current)
                    shape.shadow = new createjs.Shadow(app.shadowThis, 0, 0, 5);
                if (hover)
                    if (node.edit)
                        shape.shadow = new createjs.Shadow(app.shadowThis, 0, 0, 5);
                    else
                        shape.shadow = new createjs.Shadow(app.shadowHover, 0, 0, 5);
            },

            clickReturn() {
                //    location.href =  location.href;
            },
            clickSubmit() {
                //提交
                this.submitFlag = true;
                this.judgeLogicTree(this.curIndex, this.logicTreeHard);
            },
            clickNext() {
                location.href = location.href;
            },
            clickAvatar() {
                this.modalLevel = true;
            },
            logOut() {
                $.get("/api/logout", function () {
                    location.href = "index.html";
                });
            },
            //选中逻辑门
            chooseLogic(logic) {
                this.selectNum = '';//01 逻辑门同时只能选一个
                this.selectLogic = logic;
                createjs.Sound.play("mover");
                console.log("选中逻辑门:" + logic);
                //easy medium先选盒子也能配对
                if (this.curEMIndex === -1)
                    return;
                if (this.curIndex === 2 || this.curIndex === 3) {
                    let tree = null;
                    if (this.curIndex === 2)
                        tree = this.logicTreeEasy[this.curEMIndex];
                    else if (this.curIndex === 3)
                        tree = this.logicTreeMedium[this.curEMIndex];
                    if (!tree)
                        return;
                    tree[1][0].val = this.selectLogic;
                    let num1 = tree[0][0];
                    let num2 = tree[0][1];
                    let num3 = tree[2][0];
                    let op = tree[1][0];
                    if (this.operate(op.val, num1.val, num2.val) === num3.val) {
                        createjs.Sound.play("success");
                    } else {
                        createjs.Sound.play("fail");
                    }
                    //是否通过
                    let allRight = this._IsEasyMediumAllRight(this.curIndex);
                    this._OnAllRightChanged(allRight);
                }
            },
            //选中数字
            chooseNum(num) {
                this.selectLogic = '';//01 逻辑门同时只能选一个
                console.log("选中数字:" + num);
                this.selectNum = num;
                createjs.Sound.play("mover");
            },
            //设置时间
            startTick(time) {
                this.clockTime = time;
                clearInterval(this.tickId);
                this.tickId = setInterval(() => {
                    this.clockTime--;
                    if (this.clockTime === 0) {
                        clearInterval(this.tickId);
                        this.tickId = null;
                        app.onTimeOut();
                    }
                }, 1000);
            },
            //超时
            onTimeOut() {
                createjs.Sound.play("timeout");
                this.tipMsg = 'Opps! Time out! Would you like to try it again?';
                this.tipAlert = true;
            },
            endTick() {
                clearInterval(this.tickId);
            },
            //获取闹钟数字
            getClockNumberImg(time, index) {
                let baseUrl = '../assets/img/num/';
                let strTime = time.toString();
                if (strTime.length === 3) {
                    if (index === 0)
                        return baseUrl + strTime[0] + '.png';
                    else if (index === 1)
                        return baseUrl + strTime[1] + '.png';
                    else if (index === 2)
                        return baseUrl + strTime[2] + '.png';
                } else if (strTime.length === 1)
                    if (index === 0)
                        return baseUrl + strTime[0] + '.png';
                    else
                        return '#';
                else
                    return baseUrl + strTime[index] + '.png';
            },
            operate(op, num1, num2) {
                if (num1 === '?' || op === '?' || num1 === '?')
                    return false;
                switch (op) {
                    case 'AND':
                        return and(num1, num2);
                    case 'OR':
                        return or(num1, num2);
                    case 'NAND':
                        return nand(num1, num2);
                    case 'XOR':
                        return xor(num1, num2);
                    case 'NOR':
                        return nor(num1, num2);
                }

                function and(num1, num2) {
                    if (num1 == '1' && num2 == '1')
                        return '1';
                    return '0';
                }

                function or(num1, num2) {
                    if (num1 == '0' && num2 == '0')
                        return '0';
                    return '1';
                }

                function nand(num1, num2) {
                    if (num1 == '1' && num2 == '1')
                        return '0';
                    return '1';
                }

                function nor(num1, num2) {
                    if (num1 == '0' && num2 == '0')
                        return '1';
                    return '0';
                }

                function xor(num1, num2) {
                    if (num1 == '0' && num2 == '0')
                        return '0';
                    if (num1 == '1' && num2 == '1')
                        return '0';
                    return '1';
                }

                return false;
            },
            mouseoverBtnItem() {
                createjs.Sound.play("mover");
            },
            tipY() {//自定义弹窗yes

                //如果是通过询问或者失败再次刷新挑战
                if (this.levelPassed) {
                    location.href = location.href;
                }
                //先关闭弹窗
                this.tipAlert = false;
                //如果有二次弹窗
                if (this.msgList[this.curIndex].y) {
                    if (this.tipConfirm) {
                        this.tipAlert = false;
                        this.tipConfirm = false;
                        return;
                    }
                    this.tipMsg = this.msgList[this.curIndex].y;
                    this.tipAlert = true;
                    this.tipConfirm = true;
                }
            },
            tipN() {
                //自定义 no
                this.tipAlert = false;
            },
            clickStars(index, indexi, star) {
                if (star || index * 3 + indexi + 1 == this.currStar) {
                    //已解锁 , 跳转对应关卡
                    //未解锁 判断是否是下一关
                    //未解锁并且不是下一关 提示
                    localStorage.setItem('selectLevel', index * 3 + indexi + 1);
                    if (index > 2) {
                        this.clickMenu(3);
                    } else {
                        this.clickMenu(2);
                    }
                } else {
                    //未解锁并且不是下一关 提示
                    this.tipMsg = 'Opps! You did not unlock this level.';
                    this.tipAlert = true;
                }
            },
            clickTipYes() {
                //自定义对话框YES按钮点击事件
                this.modalTips = false;
            },
            clickTipNo() {
                //自定义对话框NO按钮点击事件
                this.modalTips = false;
            },
        },
    })
</script>

<style>
    .modal-custom-body {
        position: relative;
    }

    .modal-custom-body .m-bg {
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
    }

    .modal-custom-body .m-content {
        width: 80%;
        position: absolute;
        top: 90px;
        left: 40px;
    }

    .modal-custom-body .m-content p {
        font-size: 17px;
    }

    .modal-custom-body .row-button {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-custom-body .row-button img {
        margin-top: 170px;
        width: 80px;
        cursor: pointer;
    }

    .z-modal .ivu-modal-content {
        background: transparent;
        box-shadow: none;
    }

    .z-modal .ivu-modal-close {
        display: none;
    }

    .row-level {
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        padding: 3px 0;
    }

    .row-level .img-num {
        width: 36px;
        height: 40px;
    }

    .row-level .img-star {
        width: 32px;
    }

    .level-body {
        display: flex;
        justify-content: center;
        margin-top: -3vh;
    }

    .level-content {
        position: relative;
    }

    .level-content .row-img {
        display: flex;
        justify-content: center;
        margin-bottom: 5px;
    }

    .level-content .level-box {
        width: 280px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around
    }

    .level-content .level-box .item {
        margin-bottom: 10px;
    }

    .level-content .level-box .item-img {
        width: 50px;
        margin: 0 20px;
    }

    .level-content .level-box .row-stars {
        margin-top: -28px;
        text-align: center;
    }

    .level-content .level-box .row-stars img {
        width: 10px;
        margin: 1px;
    }

    .level-content .row-img img {
        height: 20px
    }

    .level-bg {
        z-index: -1;
        position: absolute;
        top: 10px;
        width: 280px;
        height: 550px;
    }

    .level-modal .ivu-modal {
        top: 10px;
    }

    .img-ribbon {
        width: 280px;
        height: 80px;
    }

    .img-level-close {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        cursor: pointer;
    }

    .div-avatar {
        position: fixed;
        left: 24px;
        top: 24px;
    }

    .div-avatar img {
        width: 36px;
        cursor: pointer;
    }

    .div-music {
        position: fixed;
        right: 20px;
        top: 20px;
    }

    .div-logout {
        position: fixed;
        right: 100px;
        top: 20px;
    }

    .div-logout span {
        width: 60px;
        color: white;
        font-family: fantasy;
        font-size: 20px;
    }

    .div-music img {
        width: 50px;
    }

    .select-num {
        border: 2px solid #2b85e4;
        border-radius: 5px;
    }

    .div-clock {
        width: 125px;
        height: 115px;
        background: url("../assets/img/page/clock.png");
        background-size: cover;
        text-align: center;
        padding-top: 40px;
        margin-bottom: 0px;
    }

    .div-clock .img-number {
        position: relative;
        height: 48px;
        width: 40px;
    }

    .zero-one {
        text-align: center;
    }

    .zero-one img {
        height: 8vh;
        margin-left: 20px;
        margin-right: 20px;
        cursor: pointer;
    }

    .logic-legend {
        text-align: center;
    }

    .logic-legend img {
        width: 80%;
        cursor: pointer;
    }

    .select-logic {
        border-radius: 5px;
        box-shadow: 0 0 5px #087d93;
        width: 85% !important;
    }

    .main-right {
        background: #d3f0f4cc;
        border-radius: 5px;
        display: flex;
        height: 70vh;
    }

    .main-right .left {
        display: flex;
        flex-direction: column;
    }

    .main-right .right {
        width: 7vw;
        display: flex;
        flex-shrink: 0;
        flex-direction: column;
        justify-content: space-evenly;
    }

    .logic-graph {
        background: white;
        display: flex;
        margin: 20px 40px 10px 40px;
        border: 1px #9acad4 solid;
        border-radius: 5px;
    }

    #graph1 {
        margin: 50px 80px;
    }

    #graph23 {
        flex-grow: 1;
        padding: 20px;
        border: none;
        margin: 0;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: space-evenly;
        flex-wrap: wrap;
    }

    #graph23 canvas {
        padding-left: 5px;
        padding-right: 5px;
        background: white;
        border: 1px #9acad4 solid;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    #graph23 canvas:hover {
        box-shadow: 0 0 10px #aaaa;
    }

    #graph23 canvas.active {
        border: 1px #e13d13 solid;
    }


    .div-btn {
        flex-shrink: 0;
        width: 28%;
        padding-left: 2%;
        padding-right: 2%;
        box-sizing: border-box;
    }

    .div-btn img.active {
        width: 100%;
    }

    .div-btn img {
        width: 85%;
        transition: all 0.2s;
        cursor: pointer;
    }

    .div-btn img:hover {
        width: 100%;
    }

    .div-main {
        display: flex;
        padding-right: 5%;
    }


    .row-title {
        text-align: center;
    }

    .row-title img {
        margin-top: 2vh;
        width: 50%;
    }

    .row-action {
        margin-top: -10px;
        align-items: center;
        display: flex;
        padding-right: 5%;
    }

    .div-action {
        width: 10%;
    }

    .div-action img {
        width: 100%;
    }

    .div-yes-no {
        margin-top: -60px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .div-yes-no img {
        cursor: pointer;
        width: 80px;
        box-sizing: border-box;
    }
</style>
</html>